# Configuration WAF pour Nginx avec ModSecurity
# À intégrer dans la configuration Nginx Proxy Manager ou Nginx standard

# Pages d'erreur personnalisées
error_page 404 /errors/404.html;
error_page 403 /errors/403.html;
error_page 401 /errors/401.html;
error_page 429 /errors/429.html;
error_page 500 502 503 504 /errors/500.html;

# Servir les pages d'erreur depuis le backend
location ~ ^/errors/(404|403|401|429|500)\.html$ {
    proxy_pass http://cookingrecipes-api:7272$request_uri;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_intercept_errors off;
}

# Activer ModSecurity (si installé)
# modsecurity on;
# modsecurity_rules_file /etc/nginx/modsec/main.conf;

# Limites de taille pour prévenir les attaques
client_max_body_size 10M;
client_body_buffer_size 128k;
client_header_buffer_size 1k;
large_client_header_buffers 4 4k;

# Timeouts pour prévenir les attaques de déni de service
client_body_timeout 10s;
client_header_timeout 10s;
keepalive_timeout 5s 5s;
send_timeout 10s;

# Masquer la version de Nginx
server_tokens off;

# Headers de sécurité supplémentaires
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

# Limiter les méthodes HTTP autorisées
if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$ ) {
    return 405;
}

# Bloquer les user-agents suspects
if ($http_user_agent ~* (bot|crawler|spider|scraper|curl|wget|python|java|go-http)) {
    # Autoriser certains bots légitimes (Google, etc.)
    if ($http_user_agent !~* (Googlebot|Bingbot|Slurp|DuckDuckBot|Baiduspider|YandexBot|Sogou|Exabot|facebot|ia_archiver)) {
        return 403;
    }
}

# Bloquer les requêtes avec des patterns suspects dans l'URL
location ~* \.(php|asp|aspx|jsp|cgi|pl|sh|bat|exe|com|pif|scr|vbs|js|jar|war|ear)$ {
    return 403;
}

# Bloquer les tentatives d'accès aux fichiers sensibles
location ~* \.(env|git|svn|htaccess|htpasswd|ini|log|sh|sql|bak|backup|old|orig|save|swp|tmp)$ {
    return 403;
}

# Bloquer les tentatives de path traversal
if ($request_uri ~* "\.\./") {
    return 403;
}

# Bloquer les tentatives SQL injection dans l'URL
if ($query_string ~* "(union.*select|insert.*into|delete.*from|drop.*table|create.*table|alter.*table|exec|execute|script)") {
    return 403;
}

# Bloquer les tentatives XSS dans l'URL
if ($query_string ~* "(<script|javascript:|onload=|onerror=|onclick=|onmouseover=|eval\(|expression\()") {
    return 403;
}

# Rate limiting par IP (déjà configuré dans Nginx Proxy Manager, mais on peut ajouter ici)
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/m;

# Appliquer les limites
location /api/auth/ {
    limit_req zone=auth_limit burst=3 nodelay;
    proxy_pass http://cookingrecipes-api:7272;
}

location /api/ {
    limit_req zone=api_limit burst=20 nodelay;
    proxy_pass http://cookingrecipes-api:7272;
}

# Logging des tentatives d'attaque
log_format security_log '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       '"$http_x_forwarded_for" '
                       'attack_type="$request_uri"';

access_log /var/log/nginx/security.log security_log;

