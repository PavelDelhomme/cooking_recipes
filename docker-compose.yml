services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cooking_recipes_backend
    ports:
      - "7272:7272"
    volumes:
      - ./backend/data:/app/data
      - ./backend/src:/app/src
      - ./backend/logs:/app/logs
    environment:
      - PORT=7272
      - HOST=0.0.0.0
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-in-production}
      - LIBRETRANSLATE_URL=http://libretranslate:5000
    restart: unless-stopped
    networks:
      - cooking_recipes_network
    labels:
      - "com.docker.compose.project=cooking_recipes"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: cooking_recipes_frontend
    ports:
      - "7070:8080"
    volumes:
      - ./frontend/lib:/app/lib
      - ./frontend/pubspec.yaml:/app/pubspec.yaml
    environment:
      - API_URL=http://backend:7272
    depends_on:
      - backend
      - libretranslate
    restart: unless-stopped
    networks:
      - cooking_recipes_network
    labels:
      - "com.docker.compose.project=cooking_recipes"

  libretranslate:
    image: libretranslate/libretranslate:latest
    container_name: cooking_recipes_libretranslate
    ports:
      - "7071:5000"
    environment:
      - LT_HOST=0.0.0.0
      - LT_PORT=5000
      - LT_LOAD_ONLY=en,fr,es
      - LT_CHAR_LIMIT=5000
      # Désactiver le rate limiting pour éviter les erreurs (optionnel)
      # - LT_REQ_LIMIT=100
      # Définir le répertoire de données pour éviter les problèmes de permissions
      - ARGOS_TRANSLATE_PACKAGES_DIR=/app/models
      - ARGOS_TRANSLATE_DATA_DIR=/app/data
    volumes:
      - libretranslate_models:/app/models
      - libretranslate_data:/app/data
    restart: unless-stopped
    networks:
      - cooking_recipes_network
    labels:
      - "com.docker.compose.project=cooking_recipes"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/languages"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # Plus long au premier démarrage (téléchargement des modèles)

volumes:
  libretranslate_models:
    driver: local
  libretranslate_data:
    driver: local

networks:
  cooking_recipes_network:
    driver: bridge
    name: cooking_recipes_network

